#
# Makefile for omc
#
# David Kågedal <x97davka@ida.liu.se>
#
# $Id$
#

srcdir= .
top_builddir= ..
builddir_bin=$(top_builddir)/build/bin
builddir_lib=$(top_builddir)/build/lib
builddir_inc=$(top_builddir)/build/include
builddir_doc=$(top_builddir)/build/doc

ANTLR_HOME = @antlrhome@
EXEEXT = @EXEEXT@

ANTLR_INCP = -I@antlrinc@
ANTLR_LIBP = -L@antlrlib@
LIBSOCKET = @LIBSOCKET@

SHELL	= /bin/sh
CC	= gcc
CFLAGS	= $(USE_CORBA) -DCYGWIN
RMLHOME	= @rmlhome@
#RML	= @rmlc_bin@ -g -Wc,-O3 -Wr,-East,-Ecps,-Efol
RML	= $(RMLHOME)/bin/rml
RMLINC  = -I$(RMLHOME)/include/plain

USE_CORBA = @USE_CORBA@
CORBAHOME = @CORBAHOME@

#LDFLAGS = -L$(RMLHOME)/lib/plain $(ANTLR_LIBP) -lrml_g -lm -lantlr $(LIBSOCKET) $(CORBALIB) -lm -lpthread -lreadline
#LDFLAGS = -L$(RMLHOME)/lib/plain $(ANTLR_LIBP) -lrml -lm -lantlr $(LIBSOCKET) $(CORBALIB) -lm -lpthread 

include Makefile.common

PROG = omc
PROGD = omcd

SCRIPT_FILES = Compile Compile.bat doPlot doPlot.bat doPlot.Linux
DOC_FILES = omc_helptext.txt omc_interactive_api.txt

#SUBDIRS= ast runtime
SUBDIRS	= runtime absyn_builder modpar

.SUFFIXES:
.SUFFIXES: .o .mo .h
.PHONY: all subdirs report vctarget debug release depend clean dclean test reallyclean omc_release omc_debug

#all : debug 
all : release

debug:	$(PROGD) dinstall

release: $(PROG) install

$(SRCRDB): %.rdb: omc_debug/%.rdb 
	cp $< $@

#	@for x in $(SRCRDB); do \
#		echo $$x;\
#		cp omc_debug/$$x .; \
#	done

$(PROG): omc_release
	cp omc_release/$(PROG)$(EXEEXT) $(builddir_bin)/

$(PROGD): omc_debug
	cp omc_debug/$(PROGD)$(EXEEXT) $(builddir_bin)/

install_doc:
	for x in $(DOC_FILES); do \
		echo Copying $$x into $(builddir_doc); \
		cp doc/$$x $(builddir_doc)/; \
	done
	
install_scripts:
	for x in $(SCRIPT_FILES); do \
		echo Copying $$x into $(builddir_bin); \
		cp scripts/$$x $(builddir_bin)/; \
	done


install: install_doc install_scripts
	echo Copying $(PROG)$(EXEEXT) into $(builddir_bin)
	cp omc_release/$(PROG)$(EXEEXT) $(builddir_bin)/
	echo Copying needed helpfiles....
	for x in $(DOC_FILES); do \
		echo Copying $$x into $(builddir_bin) where omc expects it...; \
		cp doc/$$x $(builddir_bin)/; \
	done

dinstall: install_doc install_scripts $(SRCRDB)
	cp *.rdb $(builddir_bin)/
	echo Copying $(PROGD)$(EXEEXT) into $(builddir_bin)
	cp omc_debug/$(PROGD)$(EXEEXT) $(builddir_bin)/
	echo Copying needed helpfiles....
	for x in $(DOC_FILES); do \
		echo Copying $$x into $(builddir_bin) where omc expects it...; \
		cp doc/$$x $(builddir_bin)/; \
	done

omc_release:
	(cd omc_release && $(MAKE))

omc_debug:
	(cd omc_debug && $(MAKE))

#vctarget:
#	@(cd omc_debug ; $(MAKE) vctarget)

vctarget: 
	@(cd omc_release ; $(MAKE) vctarget)


test:
	@(cd $(top_builddir)/testsuite ; $(MAKE))


#ast/libast.a:
#	@(cd ast ; $(MAKE) libast.a)

#subdirs:
#	@for d in $(SUBDIRS); do \
#		(cd $$d ; $(MAKE)) \
#	done

clean:
	@for d in $(SUBDIRS); do \
		(cd $$d ; $(MAKE) clean) \
	done
	(cd omc_release; $(MAKE) clean)
	-$(RM) -f $(SRCH)
	-$(RM) -f $(builddir_bin)/$(PROG)$(EXEEXT)
	-cd $(builddir_bin) && rm -f $(SCRIPT_FILES) && rm -f $(DOC_FILES)
	-cd $(builddir_doc) && rm -f $(DOC_FILES)	

dclean:
	@for d in $(SUBDIRS); do \
		(cd $$d ; $(MAKE) clean) \
	done
	(cd omc_debug; $(MAKE) clean)
	-$(RM) -f $(SRCRDB)
	-$(RM) -f $(SRCH)
	-$(RM) -f $(builddir)/$(PROGD)$(EXEEXT)
	-cd $(builddir_bin) && rm -f $(SCRIPTS_FILES) && rm -f $(DOC_FILES)
	-cd $(builddir_doc) && rm -f $(DOC_FILES)

reallyclean:
	@for d in $(SUBDIRS); do \
		(cd $$d ; $(MAKE) reallyclean) \
	done
	(cd omc_release; $(MAKE) reallyclean)
	-$(RM) -f $(SRCH)
	-$(RM) -f $(builddir)/$(PROG)$(EXEEXT)

dreallyclean: 
	@for d in $(SUBDIRS); do \
		(cd $$d ; $(MAKE) reallyclean) \
	done
	(cd omc_debug; $(MAKE) reallyclean)
	-$(RM) -f $(SRCRDB)
	-$(RM) -f $(SRCH)
	-$(RM) -f $(builddir)/$(PROGD)$(EXEEXT)

report:
	@(cd report ; $(MAKE))

depend:	
	-$(RM) .depend
	time $(RML) -fdump-depends $(SRCMO) > .depend

.PRECIOUS: Makefile

Makefile: Makefile.in
	$(top_builddir)/config.status Makefile
