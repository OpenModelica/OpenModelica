.PHONY : all omc omcd debug release mosh clean

top_builddir = .
builddir_bin=$(top_builddir)/build/bin
builddir_lib=$(top_builddir)/build/lib
builddir_inc=$(top_builddir)/build/include
builddir_doc=$(top_builddir)/build/doc
builddir_java=$(top_builddir)/build/share/omc/java/

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
includedir = @includedir@
datadir = @datadir@
docdir = @docdir@

INSTALL_BINDIR     = ${DESTDIR}${bindir}
INSTALL_LIBDIR     = ${DESTDIR}${libdir}
INSTALL_INCLUDEDIR = ${DESTDIR}${includedir}
INSTALL_DATADIR    = ${DESTDIR}${datadir}
INSTALL_DOCDIR     = ${DESTDIR}${docdir}/omc
INSTALL_JAVADIR    = ${INSTALL_DATADIR}/omc/java

all : release qtclients mosh
.PHONY : c_runtime omc omcd release debug qtclient mosh all mkbuilddirs test

mkbuilddirs:
	mkdir -p $(builddir_bin)
	mkdir -p $(builddir_lib)
	mkdir -p $(builddir_inc)
	mkdir -p $(builddir_doc)
	mkdir -p $(builddir_java)
	mkdir -p $(builddir_doc)/testmodels

debug: omcd

release: omc

c_runtime: mkbuilddirs
	$(MAKE) -C c_runtime -f Makefile

omcd: c_runtime
	(cd Compiler && $(MAKE) -f Makefile debug)
	(cp -p doc/*.pdf doc/OpenModelicaAPI-Howto/*.pdf $(builddir_doc)/)
	(cp -p Examples/*.* $(builddir_doc)/testmodels/)


omc: c_runtime
	(cd Compiler && $(MAKE) -f Makefile release)
	(cp -p doc/*.pdf doc/OpenModelicaAPI-Howto/*.pdf $(builddir_doc)/)
	(cp -p Examples/*.* $(builddir_doc)/testmodels/)

test:
	(cd testsuite; time $(MAKE) -f Makefile)

testmos:
	(cd testsuite/mosfiles; time $(MAKE) -f Makefile)

testSummary:
	(cd testsuite; time $(MAKE) -f Makefile | grep "==")

mosh: omc
	(cd mosh/src; $(MAKE) -f Makefile)

qtclients: mkbuilddirs
	echo "environment variable QTHOME should be defined"
	echo "Coin3D (www.coin3d.org) and SoQt should be installed and in the path!"
	echo "using QTHOME=${QTHOME}"
	(cd OMShell && @IDLCMD@ ../Compiler/runtime/omc_communication.idl && CORBALIBS="@CORBALIBS@" CORBAINCL="@CORBACFLAGS@" qmake && make && cp -p OMShell ../$(builddir_bin)/.)
	(cd OMNotebook/ext && qmake && make && cp -p ext ../../$(builddir_bin)/.)
	(cd OMNotebook/OMNotebookQT4 && @IDLCMD@ ../../Compiler/runtime/omc_communication.idl && USE_CORBA="@QT_USE_CORBA@" CORBALIBS="@CORBALIBS@" CORBAINCL="@CORBACFLAGS@" qmake && make && cp -p OMNotebook *.xml ../../$(builddir_bin)/.)

distclean: clean
	(cd Compiler && $(MAKE) -f Makefile reallyclean)
	(cd Compiler/omc_debug && $(MAKE) -f Makefile reallyclean)
	(cd Compiler/omc_release && $(MAKE) -f Makefile reallyclean)
	(cd Compiler/omc_profiler && $(MAKE) -f Makefile reallyclean)
	(cd modelica_parser/src && $(MAKE) -f Makefile reallyclean)
	(cd flat_modelica_parser/src && $(MAKE) -f Makefile reallyclean)
	rm -f Compiler/.depend
	rm -f OMShell/Makefile OMNotebook/ext/Makefile OMNotebook/OMNotebookQT4/Makefile
	rm -f Makefile Compiler/rml2sig/Makefile modelica_parser/test/parser/Makefile mosh/src/Makefile Compiler/Makefile Compiler/omc_release/Makefile Compiler/omc_debug/Makefile Compiler/omc_profiler/Makefile Compiler/absyn_builder/Makefile modelica_parser/test/lexer/Makefile Compiler/test_codegen/Makefile Compiler/runtime/Makefile modelica_parser/src/Makefile Compiler/modpar/Makefile flat_modelica_parser/src/Makefile
	rm -f config.status config.log
clean:
	(cd c_runtime && $(MAKE) -f Makefile clean)
	(cd Compiler/rml2sig && $(MAKE) -f Makefile clean)
	(cd Compiler && $(MAKE) -f Makefile clean)
	(cd Compiler/omc_debug && $(MAKE) -f Makefile clean)
	(cd Compiler/omc_release && $(MAKE) -f Makefile clean)
	(cd Compiler/omc_profiler && $(MAKE) -f Makefile clean)
	(cd mosh/src && $(MAKE) -f Makefile clean)
	(cd modelica_parser/src && $(MAKE) -f Makefile clean)
	(cd flat_modelica_parser/src && $(MAKE) -f Makefile clean)
	(rm -f $(builddir_doc)/*.pdf)
	(rm -f $(builddir_doc)/testmodels/*.*)
	cd OMShell && make clean || true
	cd OMNotebook/ext && make clean || true
	cd OMNotebook/OMNotebookQT4 && make clean || true
	rm -f OMNotebook/ext/ext
	rm -f OMShell/OMShell OMShell/omc_communication.*
	rm -f OMNotebook/OMNotebookQT4/OMNotebook OMNotebook/OMNotebookQT4/omc_communication.*
	(cd OMShell && qmake && make clean)
	(cd OMNotebook/ext && qmake && make clean)
	(cd OMNotebook/OMNotebookQT4 && qmake && make clean)
	(rm -f $(builddir_bin)/OMShell)
	(rm -f $(builddir_bin)/OMNotebook)
	(rm -f $(builddir_bin)/ext)
	(rm -f $(builddir_bin)/*.xml)
	rm -f build/include/*
	rm -rf build/share

${INSTALL_BINDIR}:
	mkdir -p ${INSTALL_BINDIR}

${INSTALL_LIBDIR}:
	mkdir -p ${INSTALL_LIBDIR}

${INSTALL_INCLUDEDIR}:
	mkdir -p ${INSTALL_INCLUDEDIR}

${INSTALL_DOCDIR}:
	mkdir -p ${INSTALL_DOCDIR}
	mkdir -p ${INSTALL_DOCDIR}/testmodels

${INSTALL_JAVADIR}:
	mkdir -p ${INSTALL_JAVADIR}

install: ${INSTALL_BINDIR} ${INSTALL_LIBDIR} ${INSTALL_INCLUDEDIR} ${INSTALL_DOCDIR} $(INSTALL_JAVADIR)
	echo Installing OpenModelica...
	# Binaries
	cp -p build/bin/* ${INSTALL_BINDIR}
	# Libraries
	cp -p build/lib/* ${INSTALL_LIBDIR}
	# Includes
	cp -p build/include/* ${INSTALL_INCLUDEDIR}
	# Documents
	cp -p build/doc/*.pdf ${INSTALL_DOCDIR}
	cp -p build/doc/testmodels/* ${INSTALL_DOCDIR}/testmodels
	# Java
	cp -Rp build/share/omc/java/* ${INSTALL_JAVADIR}


.PRECIOUS: Makefile

Makefile: Makefile.in
	$(top_builddir)/config.status Makefile
