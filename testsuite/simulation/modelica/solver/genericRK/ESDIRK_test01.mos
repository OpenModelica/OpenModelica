// name: ESDIRK_test01
// status: correct
// teardown_command: rm -rf temp_ESDIRK_01/
//
// Test all available generic Runge-Kutta solvers with all available non-linear solver methods.

loadFile("ESDIRK_test01.mo");
getErrorString();

echo(false);
system("rm -rf temp_ESDIRK_01/ && mkdir temp_ESDIRK_01/");
cd("temp_ESDIRK_01");
echo(true);

rkMethods := {"expl_euler",
             "impl_euler",
             "sdirk3",
             "esdirk2",
             "esdirk2_test",
             "esdirk3",
             "esdirk3_test",
             "merson",
             "dopri45"};

nlsMethods := {"newton", "kinsol"};

setCommandLineOptions("--generateSymbolicJacobian"); getErrorString();

// Build model
buildModel(ESDIRK_test01);
getErrorString();

// Create reference results
system("./ESDIRK_test01 -override=stopTime=20 -s=dassl -r ESDIRK_test_01_ref.mat ", "refSimulation.log");
print(readFile("refSimulation.log"));

// Test all RK methods
for rkMethod in rkMethods loop
  for nlsMethod in nlsMethods loop
    print("\n--------------------------------------------------------\n");
    print("Running RK " + rkMethod + " with NLS " + nlsMethod + ":\n");
    logFile := "ESDIRK_test01_"+ rkMethod + "_" + nlsMethod + ".log";
    system("./ESDIRK_test01 -override=stopTime=20 -s=genericRK -rkOpt=" + rkMethod + " -rkNLS=" + nlsMethod, logFile);
    print(readFile(logFile) + "\n");

    (success, failVars) := diffSimulationResults(actualFile = "ESDIRK_test01_res.mat",
                                 expectedFile = "ESDIRK_test_01_ref.mat",
                                 diffPrefix = "diff_" + rkMethod + "_" + nlsMethod,
                                 vars = {"der(y[1])", "der(y[2])"});
    print("Failed vars:\n");
    for var in failVars loop
      print("\t" + var + "\n");
    end for;
    if not success then
      print("Failed to compare simulation results\n");
      print(getErrorString() + "\n");
    end if;
  end for;
end for;

// Result:
// true
// ""
// true
// {"expl_euler","impl_euler","sdirk3","esdirk2","esdirk2_test","esdirk3","esdirk3_test","merson","dopri45"}
// {"newton","kinsol"}
// true
// ""
// {"ESDIRK_test01","ESDIRK_test01_init.xml"}
// ""
// 0
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
//
// --------------------------------------------------------
// Running RK expl_euler with NLS newton:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK expl_euler with NLS kinsol:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK impl_euler with NLS newton:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK impl_euler with NLS kinsol:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK sdirk3 with NLS newton:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK sdirk3 with NLS kinsol:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK esdirk2 with NLS newton:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK esdirk2 with NLS kinsol:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK esdirk2_test with NLS newton:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK esdirk2_test with NLS kinsol:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK esdirk3 with NLS newton:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK esdirk3 with NLS kinsol:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK esdirk3_test with NLS newton:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK esdirk3_test with NLS kinsol:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK merson with NLS newton:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK merson with NLS kinsol:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK dopri45 with NLS newton:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// --------------------------------------------------------
// Running RK dopri45 with NLS kinsol:
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// Failed vars:
//
// endResult
