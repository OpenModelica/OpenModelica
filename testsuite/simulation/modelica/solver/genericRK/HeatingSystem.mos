// name: HeatingSystem
// status: correct
// teardown_command: rm -rf temp_HeatingSystem/
//
// Test all available generic Runge-Kutta solvers with all available non-linear solver methods.

loadFile("HeatingSystemDiscrete.mo");
getErrorString();

loadString("
model HeatingSystem
  extends HeatingSystemDiscrete.HeatingSystem;
end HeatingSystem;
"); getErrorString();

echo(false);
system("rm -rf temp_HeatingSystem/ && mkdir temp_HeatingSystem/");
cd("temp_HeatingSystem");
echo(true);

setCommandLineOptions("--generateSymbolicJacobian"); getErrorString();

// Build model
buildModel(HeatingSystem, stopTime=864000); getErrorString();

// Create reference results
system("./HeatingSystem -s=dassl -r HeatingSystem_ref.mat -override=\"tolerance=1e-6,stopTime=864000\"", "refSimulation.log");
print(readFile("refSimulation.log"));

// Simulate with gauss2 & KINSOL+KLU
system("./HeatingSystem -s=gmode -gmsolver=gauss2 -gmnls=kinsol -override=\"tolerance=1e-6,stopTime=864000\"", "HeatingSystem_gauss2.log");
print(readFile("HeatingSystem_gauss2.log"));

diffSimulationResults(actualFile = "HeatingSystem_res.mat",
                      expectedFile = "HeatingSystem_ref.mat",
                      diffPrefix = "diff",
                      vars = {"Td"});
getErrorString();

// Simulate with sdirk2 & KINSOL+KLU
system("./HeatingSystem -s=gmode -gmsolver=sdirk2 -gmfsolver=sdirk2 -gmnls=kinsol -gmratio=1 -override=\"tolerance=1e-10,stopTime=864000\"", "HeatingSystem_gauss2.log");
print(readFile("HeatingSystem_gauss2.log"));

diffSimulationResults(actualFile = "HeatingSystem_res.mat",
                      expectedFile = "HeatingSystem_ref.mat",
                      diffPrefix = "diff",
                      vars = {"Td"});
getErrorString();

// Simulate with sdirk2 & KINSOL+KLU
system("./HeatingSystem -s=gmode -gmsolver=adams -gmfsolver=adams -gmnls=kinsol -gmratio=0 -override=\"tolerance=1e-9,stopTime=864000\"", "HeatingSystem_gauss2.log");
print(readFile("HeatingSystem_gauss2.log"));

diffSimulationResults(actualFile = "HeatingSystem_res.mat",
                      expectedFile = "HeatingSystem_ref.mat",
                      diffPrefix = "diff",
                      vars = {"Td"});
getErrorString();

// Result:
// true
// "Notification: Automatically loaded package Modelica 4.0.0 due to uses annotation.
// Notification: Automatically loaded package Complex 4.0.0 due to uses annotation.
// Notification: Automatically loaded package ModelicaServices 4.0.0 due to uses annotation.
// "
// true
// ""
// true
// true
// ""
// {"HeatingSystem","HeatingSystem_init.xml"}
// ""
// 0
// stdout            | warning | Start or stop time was overwritten, but no new integrator step size was provided.
// |                 | info    | | Re-calculating step size for 500 intervals.
// |                 | |       | | Add `stepSize=<value>` to `-override=` or override file to silence this warning.
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// 0
// stdout            | warning | Start or stop time was overwritten, but no new integrator step size was provided.
// |                 | info    | | Re-calculating step size for 500 intervals.
// |                 | |       | | Add `stepSize=<value>` to `-override=` or override file to silence this warning.
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// (true,{})
// ""
// 0
// stdout            | warning | Start or stop time was overwritten, but no new integrator step size was provided.
// |                 | info    | | Re-calculating step size for 500 intervals.
// |                 | |       | | Add `stepSize=<value>` to `-override=` or override file to silence this warning.
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// (true,{})
// ""
// 0
// stdout            | warning | Start or stop time was overwritten, but no new integrator step size was provided.
// |                 | info    | | Re-calculating step size for 500 intervals.
// |                 | |       | | Add `stepSize=<value>` to `-override=` or override file to silence this warning.
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_SUCCESS       | info    | The simulation finished successfully.
//
// (true,{})
// ""
// endResult
