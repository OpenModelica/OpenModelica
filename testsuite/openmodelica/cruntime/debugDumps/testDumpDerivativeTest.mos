// name:     testDumpDerivativeTest.mos
// keywords: kinsol jacobian dumps
// status: correct
// teardown_command: rm -rf derDebugTest* output.log
// cflags: -d=-newInst
//
// Test flag LOG_NLS_DERIVATIVE_TEST to detect anomalies in the symbolic Jacobian
//
loadString("
model derDebugTest
  Real x(start = 1e3, nominal=1e3);
  Real y(start = 1e4, nominal=1e4);
  Real z(start = 1, nominal=1);

  Real s(start=1, fixed=true, nominal=1);
equation
  x^2 + y - z^2 = 1;
  y + z^6 - x^2 = 1;
  x^3 - y  = s;

  der(s) = x;
end derDebugTest;
"); getErrorString();

simulate(derDebugTest,
         simflags="-lv=LOG_NLS_DERIVATIVE_TEST -nls=kinsol",
         startTime=0,
         stopTime=1e-3,
         numberOfIntervals=1); getErrorString();

// Result:
// true
// ""
// record SimulationResult
//     resultFile = "derDebugTest_res.mat",
//     simulationOptions = "startTime = 0.0, stopTime = 0.001, numberOfIntervals = 1, tolerance = 1e-6, method = 'dassl', fileNamePrefix = 'derDebugTest', options = '', outputFormat = 'mat', variableFilter = '.*', cflags = '', simflags = '-lv=LOG_NLS_DERIVATIVE_TEST -nls=kinsol'",
//     messages = "LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | | Numerical    1      0      8.00000e+00     8.00093e+00     1.16328e-04
// |                 | |       | | | Numerical    1      1      -2.00000e+00    -1.78885e+00    1.18034e-01
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  2 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 1.180e-01
// |                 | warning | | | Derivative test failed (2 numerical, 0 structural errors)
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | | Numerical    1      0      8.00000e+00     8.00093e+00     1.16328e-04
// |                 | |       | | | Numerical    1      1      -2.00000e+00    -1.78885e+00    1.18034e-01
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  2 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 1.180e-01
// |                 | warning | | | Derivative test failed (2 numerical, 0 structural errors)
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | | Numerical    1      1      2.51979e+01     2.51249e+01     2.90614e-03
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  1 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.906e-03
// |                 | warning | | | Derivative test failed (1 numerical, 0 structural errors)
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | | Numerical    1      1      1.70417e+01     1.70391e+01     1.57661e-04
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  1 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 1.577e-04
// |                 | warning | | | Derivative test failed (1 numerical, 0 structural errors)
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 6.024e-06
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.088e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.265e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.503e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.711e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.713e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.711e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.711e-07
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.717e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.698e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.713e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.702e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.695e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.702e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.705e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.713e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.719e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.711e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.701e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.696e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.715e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.701e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.712e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.708e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.703e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.706e-07
// LOG_NLS_DERIVATIVE_TEST | info    | KINSOL: Derivative test (tol=1.00000e-04, scaling=0):
// |                 | |       | | Anomalies
// |                 | |       | | | Type         Col    Row    Symbolic        Numerical       RelError
// |                 | |       | | Summary:
// |                 | |       | | | Numerical errors:  0 (values mismatch w.r.t. reference)
// |                 | |       | | | Structural errors: 0 (non-zero not in sparsity pattern)
// |                 | |       | | | Max relative error: 2.705e-07
// LOG_SUCCESS       | info    | The simulation finished successfully.
// "
// end SimulationResult;
// ""
// endResult
