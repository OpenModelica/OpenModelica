// name: ExtendsReduceDrumBoiler
// cflags: --flowThreshold=1e-15 -d=-newInst
// status: correct

loadModel(Modelica,{"3.2"});
getErrorString();

loadFile("DrumBoiler.mo");
getErrorString();

res :=simulate(drumBoiler.optDrumBoiler, stopTime=3600, simflags="-emit_protected", fileNamePrefix = "init");

setCommandLineOptions("--postOptModules+=reduceDynamicOptimization +loop2con=noLin");
getErrorString();

res :=optimize(drumBoiler.optDrumBoiler, stopTime=3600, numberOfIntervals=50, tolerance=1e-4, simflags="-lv=LOG_IPOPT_ERROR -optimizerNP 1 -s optimization -iif init_res.mat -ipopt_init FILE -ipopt_max_iter=100");
getErrorString();

res := OpenModelica.Scripting.compareSimulationResults("drumBoiler.optDrumBoiler_res.mat","ReferenceFiles/drumBoiler.optDrumBoiler_ref.mat","drumBoiler.optDrumBoiler_res.csv",0.01,0.0001,{"controller.x", "evaporator.V_l", "evaporator.p", "q_F", "Y_Valve", "dq_F"});
getErrorString();

// Result:
// true
// ""
// true
// ""
// record SimulationResult
//     resultFile = "init_res.mat",
//     simulationOptions = "startTime = 0.0, stopTime = 3600.0, numberOfIntervals = 500, tolerance = 1e-05, method = 'dassl', fileNamePrefix = 'init', options = '', outputFormat = 'mat', variableFilter = '.*', cflags = '', simflags = '-emit_protected'",
//     messages = "assert            | warning | The following assertion has been violated at time 0.000000
// |                 | |       | der_evaporator_p >= 0.0 and der_evaporator_p <= 32000.0
// assert            | warning | Variable violating min/max constraint: 0.0 <= der_evaporator_p <= 32000.0, has value: -9.57311
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
// assert            | info    | The following assertion has been violated at time 849.600000
// |                 | |       | conSigma.con >= conSigma.MinValue and conSigma.con <= conSigma.MaxValue
// assert            | info    | Variable violating min/max constraint: conSigma.MinValue <= conSigma.con <= conSigma.MaxValue, has value: -150.308
// assert            | info    | The following assertion has been violated at time 1252.800000
// |                 | |       | der_V_v >= -0.02 and der_V_v <= 0.025
// assert            | info    | Variable violating min/max constraint: -0.02 <= der_V_v <= 0.025, has value: 0.0252797
// LOG_SUCCESS       | info    | The simulation finished successfully.
// "
// end SimulationResult;
// true
// "Warning: The model contains alias variables with redundant start and/or conflicting nominal values. It is recommended to resolve the conflicts, because otherwise the system could be hard to solve. To print the conflicting alias sets and the chosen candidates please use -d=aliasConflicts.
// "
// record SimulationResult
//     resultFile = "drumBoiler.optDrumBoiler_res.mat",
//     simulationOptions = "startTime = 0.0, stopTime = 3600.0, numberOfIntervals = 50, tolerance = 0.0001, method = 'dassl', fileNamePrefix = 'drumBoiler.optDrumBoiler', options = '', outputFormat = 'mat', variableFilter = '.*', cflags = '', simflags = '-lv=LOG_IPOPT_ERROR -optimizerNP 1 -s optimization -iif init_res.mat -ipopt_init FILE -ipopt_max_iter=100'",
//     messages = "assert            | warning | The following assertion has been violated at time 0.000000
// |                 | |       | $EqCon$der_evaporator_p >= 0.0 and $EqCon$der_evaporator_p <= 0.0
// assert            | warning | Variable violating min/max constraint: 0.0 <= $EqCon$der_evaporator_p <= 0.0, has value: -1.33747e+06
// assert            | warning | The following assertion has been violated at time 0.000000
// |                 | |       | $EqCon$der_V_v >= 0.0 and $EqCon$der_V_v <= 0.0
// assert            | warning | Variable violating min/max constraint: 0.0 <= $EqCon$der_V_v <= 0.0, has value: -0.5
// LOG_SUCCESS       | info    | The initialization finished successfully without homotopy method.
//
// Optimizer Variables
// ========================================================
// State[0]:controller.x(start = 0, nominal = 10, min = -Inf, max = +Inf, init = 0)
// State[1]:evaporator.V_l(start = 67, nominal = 68, min = -Inf, max = +Inf, init = 67)
// State[2]:evaporator.p(start = 100000, nominal = 1e+06, min = 611.657, max = 1e+08, init = 100000)
// State[3]:q_F(start = 0, nominal = 400, min = 0, max = 500, init = 0)
// Input[4]:$der_V_v(start = 0, nominal = 0.025, min = -0.02, max = 0.025)
// Input[5]:$der_evaporator_p(start = 0, nominal = 32000, min = 0, max = 32000)
// Input[6]:Y_Valve(start = 0.5, nominal = 1, min = 0, max = 1)
// Input[7]:dq_F(start = 0.1, nominal = 0.416667, min = -0.416667, max = 0.416667)
// --------------------------------------------------------
// number of nonlinear constraints: 3
// ========================================================
// stdout            | info    | Using values from file as initial guess.
//
// max_iter = 100
// ******************************************************************************
// This program contains Ipopt, a library for large-scale nonlinear optimization.
//  Ipopt is released as open source code under the Eclipse Public License (EPL).
//          For more information visit https://github.com/coin-or/Ipopt
// ******************************************************************************
//
// LOG_IPOPT_ERROR   | info    | max violation is 2.97643e+07 for the constraint $EqCon$der_evaporator_p(time = 72)
// LOG_IPOPT_ERROR   | info    | max violation is 2.87941e+07 for the constraint $EqCon$der_evaporator_p(time = 72)
// LOG_IPOPT_ERROR   | info    | max violation is 2.71529e+07 for the constraint $EqCon$der_evaporator_p(time = 72)
// LOG_IPOPT_ERROR   | info    | max violation is 2.39704e+07 for the constraint $EqCon$der_evaporator_p(time = 72)
// LOG_IPOPT_ERROR   | info    | max violation is 2.20699e+07 for the constraint $EqCon$der_evaporator_p(time = 72)
// LOG_IPOPT_ERROR   | info    | max violation is 2.0034e+07 for the constraint $EqCon$der_evaporator_p(time = 72)
// LOG_IPOPT_ERROR   | info    | max violation is 3.22943e+07 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 3.14662e+07 for the constraint $EqCon$der_evaporator_p(time = 1152)
// LOG_IPOPT_ERROR   | info    | max violation is 9.21167e+06 for the constraint $EqCon$der_evaporator_p(time = 1152)
// LOG_IPOPT_ERROR   | info    | max violation is 6.2375e+06 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 1.01122e+07 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 5.12686e+06 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 8.92589e+06 for the constraint $EqCon$der_evaporator_p(time = 936)
// LOG_IPOPT_ERROR   | info    | max violation is 8.09654e+06 for the constraint $EqCon$der_evaporator_p(time = 936)
// LOG_IPOPT_ERROR   | info    | max violation is 6.4911e+06 for the constraint $EqCon$der_evaporator_p(time = 936)
// LOG_IPOPT_ERROR   | info    | max violation is 4.14213e+06 for the constraint $EqCon$der_evaporator_p(time = 864)
// LOG_IPOPT_ERROR   | info    | max violation is 3.1403e+06 for the constraint $EqCon$der_evaporator_p(time = 864)
// LOG_IPOPT_ERROR   | info    | max violation is 1.8733e+06 for the constraint $EqCon$der_evaporator_p(time = 864)
// LOG_IPOPT_ERROR   | info    | max violation is 1.48378e+07 for the constraint $EqCon$der_evaporator_p(time = 792)
// LOG_IPOPT_ERROR   | info    | max violation is 1.29259e+07 for the constraint $EqCon$der_evaporator_p(time = 792)
// LOG_IPOPT_ERROR   | info    | max violation is 3.93571e+07 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 4.45082e+06 for the constraint $EqCon$der_evaporator_p(time = 1152)
// LOG_IPOPT_ERROR   | info    | max violation is 7.38693e+06 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 2.38026e+06 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 5.33019e+06 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 1.22884e+07 for the constraint $EqCon$der_evaporator_p(time = 720)
// LOG_IPOPT_ERROR   | info    | max violation is 1.07182e+07 for the constraint $EqCon$der_evaporator_p(time = 720)
// LOG_IPOPT_ERROR   | info    | max violation is 7.36816e+06 for the constraint $EqCon$der_evaporator_p(time = 1152)
// LOG_IPOPT_ERROR   | info    | max violation is 506071 for the constraint $EqCon$der_evaporator_p(time = 1224)
// LOG_IPOPT_ERROR   | info    | max violation is 6.48993e+06 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 1.31578e+06 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 2.77274e+06 for the constraint $EqCon$der_evaporator_p(time = 648)
// LOG_IPOPT_ERROR   | info    | max violation is 2.56174e+06 for the constraint $EqCon$der_evaporator_p(time = 648)
// LOG_IPOPT_ERROR   | info    | max violation is 1.48373e+06 for the constraint $EqCon$der_evaporator_p(time = 1080)
// LOG_IPOPT_ERROR   | info    | max violation is 481307 for the constraint $EqCon$der_evaporator_p(time = 1080)
// LOG_IPOPT_ERROR   | info    | max violation is 651180 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 469134 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 104870 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 33654 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 8737.97 for the constraint $EqCon$der_evaporator_p(time = 3600)
// LOG_IPOPT_ERROR   | info    | max violation is 2720.48 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 1043.54 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 264.145 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 66.0918 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 16.5483 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 4.14006 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 1.03574 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 0.259309 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 0.0648145 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 0.0161903 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 0.00403462 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 0.000994559 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 0.000237345 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_IPOPT_ERROR   | info    | max violation is 4.92986e-05 for the constraint $EqCon$der_evaporator_p(time = 1296)
// LOG_SUCCESS       | info    | The simulation finished successfully.
// "
// end SimulationResult;
// "Warning: The model contains alias variables with redundant start and/or conflicting nominal values. It is recommended to resolve the conflicts, because otherwise the system could be hard to solve. To print the conflicting alias sets and the chosen candidates please use -d=aliasConflicts.
// "
// {"Files Equal!"}
// "Warning: 'compareSimulationResults' is deprecated. It is recommended to use 'diffSimulationResults' instead.
// "
// endResult
